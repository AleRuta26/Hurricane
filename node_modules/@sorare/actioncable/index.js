"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ActionCable = void 0;

var _ws = _interopRequireDefault(require("ws"));

var _string_decoder = require("string_decoder");

var _subscription = require("./subscription");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); Object.defineProperty(Constructor, "prototype", { writable: false }); return Constructor; }

var MessageType;

(function (MessageType) {
  MessageType["Welcome"] = "welcome";
  MessageType["Ping"] = "ping";
  MessageType["Confirmation"] = "confirm_subscription";
  MessageType["Rejection"] = "reject_subscription";
  MessageType["Disconnect"] = "disconnect";
})(MessageType || (MessageType = {}));

var ActionCable = /*#__PURE__*/function () {
  function ActionCable(options) {
    _classCallCheck(this, ActionCable);

    // options
    this.url = options.url || 'wss://ws.sorare.com/cable';
    this.origin = options.origin;
    this.headers = options.headers || {}; // heartbeat state

    this.lastHeartbeatTimestamp = 0;
    this.heartbeatInterval = undefined; // web socket

    this.connection = undefined;
    this.subscriptions = {};
    this.connectionPromise = this.connect();
  }

  _createClass(ActionCable, [{
    key: "subscribe",
    value: function subscribe(query, callbacks) {
      var identifier = JSON.stringify({
        channel: 'GraphqlChannel',
        channelId: Math.random().toString(36).substring(2, 8) // temporary

      });

      if (this.subscriptions[identifier]) {
        throw new Error('Already subscribed to this event.');
      }

      this.subscriptions[identifier] = new _subscription.Subscription(query, identifier, this.connectionPromise, callbacks);
      return this.subscriptions[identifier];
    }
  }, {
    key: "connect",
    value: function connect() {
      var _this = this;

      return new Promise(function (resolve, reject) {
        var connection = new _ws.default(_this.url, undefined, {
          origin: _this.origin,
          headers: _this.headers
        });
        connection.on('error', function (err) {
          _this.disconnect(err);

          reject(err);
        });
        connection.on('close', function () {
          return _this.disconnect('closed');
        });
        connection.on('message', function (msg) {
          var decoder = new _string_decoder.StringDecoder('utf8');
          var data = JSON.parse(decoder.write(msg));

          _this.handleMessage(data);
        });
        connection.on('open', function () {
          _this.heartbeatInterval = setInterval(function () {
            return _this.checkHeartbeat();
          }, 10000);
          resolve(connection);
        });
        _this.connection = connection;
      });
    }
  }, {
    key: "disconnect",
    value: function disconnect(err) {
      var _this2 = this;

      if (this.heartbeatInterval) {
        clearInterval(this.heartbeatInterval);
      }

      Object.entries(this.subscriptions).forEach(function (_ref) {
        var _subscription$callbac, _subscription$callbac2;

        var _ref2 = _slicedToArray(_ref, 2),
            query = _ref2[0],
            subscription = _ref2[1];

        (_subscription$callbac = (_subscription$callbac2 = subscription.callbacks).disconnected) === null || _subscription$callbac === void 0 ? void 0 : _subscription$callbac.call(_subscription$callbac2, err);
        delete _this2.subscriptions[query];
      });
    }
  }, {
    key: "handleMessage",
    value: function handleMessage(data) {
      var _sub$callbacks$connec, _sub$callbacks, _sub$callbacks$reject, _sub$callbacks2;

      var sub = this.subscriptions[data.identifier];
      var type = data.type;

      switch (type) {
        case MessageType.Welcome:
          break;

        case MessageType.Ping:
          this.lastHeartbeatTimestamp = +new Date();
          break;

        case MessageType.Confirmation:
          (_sub$callbacks$connec = (_sub$callbacks = sub.callbacks).connected) === null || _sub$callbacks$connec === void 0 ? void 0 : _sub$callbacks$connec.call(_sub$callbacks);
          break;

        case MessageType.Rejection:
          (_sub$callbacks$reject = (_sub$callbacks2 = sub.callbacks).rejected) === null || _sub$callbacks$reject === void 0 ? void 0 : _sub$callbacks$reject.call(_sub$callbacks2);
          break;

        case MessageType.Disconnect:
          this.disconnect(data.reason);
          break;

        default:
          sub.callbacks.received(data.message);
          break;
      }
    }
  }, {
    key: "checkHeartbeat",
    value: function checkHeartbeat() {
      if (!this.connection || !this.lastHeartbeatTimestamp) {
        return;
      }

      var isFlat = this.lastHeartbeatTimestamp + 10 * 1000 < +new Date();

      if (isFlat) {
        this.connection.close();
      }
    }
  }]);

  return ActionCable;
}();

exports.ActionCable = ActionCable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJNZXNzYWdlVHlwZSIsIkFjdGlvbkNhYmxlIiwib3B0aW9ucyIsInVybCIsIm9yaWdpbiIsImhlYWRlcnMiLCJsYXN0SGVhcnRiZWF0VGltZXN0YW1wIiwiaGVhcnRiZWF0SW50ZXJ2YWwiLCJ1bmRlZmluZWQiLCJjb25uZWN0aW9uIiwic3Vic2NyaXB0aW9ucyIsImNvbm5lY3Rpb25Qcm9taXNlIiwiY29ubmVjdCIsInF1ZXJ5IiwiY2FsbGJhY2tzIiwiaWRlbnRpZmllciIsIkpTT04iLCJzdHJpbmdpZnkiLCJjaGFubmVsIiwiY2hhbm5lbElkIiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic3Vic3RyaW5nIiwiRXJyb3IiLCJTdWJzY3JpcHRpb24iLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIldlYlNvY2tldCIsIm9uIiwiZXJyIiwiZGlzY29ubmVjdCIsIm1zZyIsImRlY29kZXIiLCJTdHJpbmdEZWNvZGVyIiwiZGF0YSIsInBhcnNlIiwid3JpdGUiLCJoYW5kbGVNZXNzYWdlIiwic2V0SW50ZXJ2YWwiLCJjaGVja0hlYXJ0YmVhdCIsImNsZWFySW50ZXJ2YWwiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsInN1YnNjcmlwdGlvbiIsImRpc2Nvbm5lY3RlZCIsInN1YiIsInR5cGUiLCJXZWxjb21lIiwiUGluZyIsIkRhdGUiLCJDb25maXJtYXRpb24iLCJjb25uZWN0ZWQiLCJSZWplY3Rpb24iLCJyZWplY3RlZCIsIkRpc2Nvbm5lY3QiLCJyZWFzb24iLCJyZWNlaXZlZCIsIm1lc3NhZ2UiLCJpc0ZsYXQiLCJjbG9zZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBUUtBLFc7O1dBQUFBLFc7QUFBQUEsRUFBQUEsVztBQUFBQSxFQUFBQSxXO0FBQUFBLEVBQUFBLFc7QUFBQUEsRUFBQUEsVztBQUFBQSxFQUFBQSxX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QUt6QixVQUFMLENBQWdCSSxJQUFJLENBQUNzQixNQUFyQjtBQUNBOztBQUNGO0FBQ0VWLFVBQUFBLEdBQUcsQ0FBQ2xDLFNBQUosQ0FBYzZDLFFBQWQsQ0FBdUJ2QixJQUFJLENBQUN3QixPQUE1QjtBQUNBO0FBakJKO0FBbUJEOzs7V0FFRCwwQkFBeUI7QUFDdkIsVUFBSSxDQUFDLEtBQUtuRCxVQUFOLElBQW9CLENBQUMsS0FBS0gsc0JBQTlCLEVBQXNEO0FBQ3BEO0FBQ0Q7O0FBRUQsVUFBTXVELE1BQU0sR0FBRyxLQUFLdkQsc0JBQUwsR0FBOEIsS0FBSyxJQUFuQyxHQUEwQyxDQUFDLElBQUk4QyxJQUFKLEVBQTFEOztBQUNBLFVBQUlTLE1BQUosRUFBWTtBQUNWLGFBQUtwRCxVQUFMLENBQWdCcUQsS0FBaEI7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgeyBTdHJpbmdEZWNvZGVyIH0gZnJvbSAnc3RyaW5nX2RlY29kZXInO1xuXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24sIENhbGxiYWNrcyB9IGZyb20gJy4vc3Vic2NyaXB0aW9uJztcblxuZXhwb3J0IHR5cGUgT3B0aW9ucyA9IHtcbiAgdXJsPzogc3RyaW5nO1xuICBvcmlnaW4/OiBzdHJpbmc7XG4gIGhlYWRlcnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xufTtcblxuZW51bSBNZXNzYWdlVHlwZSB7XG4gIFdlbGNvbWUgPSAnd2VsY29tZScsXG4gIFBpbmcgPSAncGluZycsXG4gIENvbmZpcm1hdGlvbiA9ICdjb25maXJtX3N1YnNjcmlwdGlvbicsXG4gIFJlamVjdGlvbiA9ICdyZWplY3Rfc3Vic2NyaXB0aW9uJyxcbiAgRGlzY29ubmVjdCA9ICdkaXNjb25uZWN0Jyxcbn1cblxuZXhwb3J0IGNsYXNzIEFjdGlvbkNhYmxlIHtcbiAgcHJpdmF0ZSB1cmw6IHN0cmluZztcblxuICBwcml2YXRlIG9yaWdpbj86IHN0cmluZztcblxuICBwcml2YXRlIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgcHJpdmF0ZSBjb25uZWN0aW9uPzogV2ViU29ja2V0O1xuXG4gIHByaXZhdGUgY29ubmVjdGlvblByb21pc2U6IFByb21pc2U8V2ViU29ja2V0PjtcblxuICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IFJlY29yZDxzdHJpbmcsIFN1YnNjcmlwdGlvbj47XG5cbiAgcHJpdmF0ZSBsYXN0SGVhcnRiZWF0VGltZXN0YW1wOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBoZWFydGJlYXRJbnRlcnZhbD86IE5vZGVKUy5UaW1lcjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBPcHRpb25zKSB7XG4gICAgLy8gb3B0aW9uc1xuICAgIHRoaXMudXJsID0gb3B0aW9ucy51cmwgfHwgJ3dzczovL3dzLnNvcmFyZS5jb20vY2FibGUnO1xuICAgIHRoaXMub3JpZ2luID0gb3B0aW9ucy5vcmlnaW47XG4gICAgdGhpcy5oZWFkZXJzID0gb3B0aW9ucy5oZWFkZXJzIHx8IHt9O1xuXG4gICAgLy8gaGVhcnRiZWF0IHN0YXRlXG4gICAgdGhpcy5sYXN0SGVhcnRiZWF0VGltZXN0YW1wID0gMDtcbiAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsID0gdW5kZWZpbmVkO1xuXG4gICAgLy8gd2ViIHNvY2tldFxuICAgIHRoaXMuY29ubmVjdGlvbiA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSB7fTtcbiAgICB0aGlzLmNvbm5lY3Rpb25Qcm9taXNlID0gdGhpcy5jb25uZWN0KCk7XG4gIH1cblxuICBzdWJzY3JpYmUocXVlcnk6IHN0cmluZywgY2FsbGJhY2tzOiBDYWxsYmFja3MpOiBTdWJzY3JpcHRpb24ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBjaGFubmVsOiAnR3JhcGhxbENoYW5uZWwnLFxuICAgICAgY2hhbm5lbElkOiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgOCksIC8vIHRlbXBvcmFyeVxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uc1tpZGVudGlmaWVyXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbHJlYWR5IHN1YnNjcmliZWQgdG8gdGhpcyBldmVudC4nKTtcbiAgICB9XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnNbaWRlbnRpZmllcl0gPSBuZXcgU3Vic2NyaXB0aW9uKFxuICAgICAgcXVlcnksXG4gICAgICBpZGVudGlmaWVyLFxuICAgICAgdGhpcy5jb25uZWN0aW9uUHJvbWlzZSxcbiAgICAgIGNhbGxiYWNrc1xuICAgICk7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaXB0aW9uc1tpZGVudGlmaWVyXTtcbiAgfVxuXG4gIHByaXZhdGUgY29ubmVjdCgpOiBQcm9taXNlPFdlYlNvY2tldD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gbmV3IFdlYlNvY2tldCh0aGlzLnVybCwgdW5kZWZpbmVkLCB7XG4gICAgICAgIG9yaWdpbjogdGhpcy5vcmlnaW4sXG4gICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycyxcbiAgICAgIH0pO1xuXG4gICAgICBjb25uZWN0aW9uLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KGVycik7XG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfSk7XG4gICAgICBjb25uZWN0aW9uLm9uKCdjbG9zZScsICgpID0+IHRoaXMuZGlzY29ubmVjdCgnY2xvc2VkJykpO1xuICAgICAgY29ubmVjdGlvbi5vbignbWVzc2FnZScsIChtc2c6IFdlYlNvY2tldC5SYXdEYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcigndXRmOCcpO1xuICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShkZWNvZGVyLndyaXRlKG1zZyBhcyBCdWZmZXIpKTtcbiAgICAgICAgdGhpcy5oYW5kbGVNZXNzYWdlKGRhdGEpO1xuICAgICAgfSk7XG4gICAgICBjb25uZWN0aW9uLm9uKCdvcGVuJywgKCkgPT4ge1xuICAgICAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsID0gc2V0SW50ZXJ2YWwoXG4gICAgICAgICAgKCkgPT4gdGhpcy5jaGVja0hlYXJ0YmVhdCgpLFxuICAgICAgICAgIDEwMDAwXG4gICAgICAgICk7XG4gICAgICAgIHJlc29sdmUoY29ubmVjdGlvbik7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5jb25uZWN0aW9uID0gY29ubmVjdGlvbjtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZGlzY29ubmVjdChlcnI/OiBhbnkpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5oZWFydGJlYXRJbnRlcnZhbCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmhlYXJ0YmVhdEludGVydmFsKTtcbiAgICB9XG5cbiAgICBPYmplY3QuZW50cmllcyh0aGlzLnN1YnNjcmlwdGlvbnMpLmZvckVhY2goKFtxdWVyeSwgc3Vic2NyaXB0aW9uXSkgPT4ge1xuICAgICAgc3Vic2NyaXB0aW9uLmNhbGxiYWNrcy5kaXNjb25uZWN0ZWQ/LihlcnIpO1xuICAgICAgZGVsZXRlIHRoaXMuc3Vic2NyaXB0aW9uc1txdWVyeV07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZU1lc3NhZ2UoZGF0YTogYW55KSB7XG4gICAgY29uc3Qgc3ViID0gdGhpcy5zdWJzY3JpcHRpb25zW2RhdGEuaWRlbnRpZmllcl07XG4gICAgY29uc3QgdHlwZSA9IGRhdGEudHlwZSBhcyBNZXNzYWdlVHlwZTtcblxuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBNZXNzYWdlVHlwZS5XZWxjb21lOlxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTWVzc2FnZVR5cGUuUGluZzpcbiAgICAgICAgdGhpcy5sYXN0SGVhcnRiZWF0VGltZXN0YW1wID0gK25ldyBEYXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBNZXNzYWdlVHlwZS5Db25maXJtYXRpb246XG4gICAgICAgIHN1Yi5jYWxsYmFja3MuY29ubmVjdGVkPy4oKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1lc3NhZ2VUeXBlLlJlamVjdGlvbjpcbiAgICAgICAgc3ViLmNhbGxiYWNrcy5yZWplY3RlZD8uKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBNZXNzYWdlVHlwZS5EaXNjb25uZWN0OlxuICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoZGF0YS5yZWFzb24pO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHN1Yi5jYWxsYmFja3MucmVjZWl2ZWQoZGF0YS5tZXNzYWdlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0hlYXJ0YmVhdCgpIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbiB8fCAhdGhpcy5sYXN0SGVhcnRiZWF0VGltZXN0YW1wKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaXNGbGF0ID0gdGhpcy5sYXN0SGVhcnRiZWF0VGltZXN0YW1wICsgMTAgKiAxMDAwIDwgK25ldyBEYXRlKCk7XG4gICAgaWYgKGlzRmxhdCkge1xuICAgICAgdGhpcy5jb25uZWN0aW9uLmNsb3NlKCk7XG4gICAgfVxuICB9XG59XG4iXX0=